{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"]},"docs":[{"location":"","title":"Welcome to my Digital Garden","text":""},{"location":"#welcome-to-my-digital-garden","title":"Welcome to my Digital Garden","text":"<p>This page on Ness Labs succinctly summarizes what a \"Digital Garden\" is</p> <p>A digital garden is an online space at the intersection of a notebook and a blog, where digital gardeners share seeds of thoughts to be cultivated in public. Contrary to a blog, where articles and essays have a publication date and start decaying as soon as they are published, a digital garden is evergreen: digital gardeners keep on editing and refining their notes.</p> <p>I've always struggled with what to take notes in. I landed on Obsidian a while back, and have been slowly building out my personal notebook. It's not perfect by any means, but it is straightforward, and the notes are just Markdown files for easy use elsewhere.</p>"},{"location":"#about-me","title":"About Me","text":"<p>I'm currently a Senior Cloud Solution Architect at Microsoft, specializing in Security, Compliance and Identity. You can find me in all the usual places like LinkedIn</p>"},{"location":"M365/Fresh_Tenant_Setup/","title":"Fresh Tenant Setup","text":"<p>These are the steps I typically take to set up a fresh M365 E5 tenant.</p> <p>Work in Progress</p> <p>This is very much a continuous work in progress. I publish changes as I go. Screenshots might be out of date.</p> <p>Use at your own risk</p> <p>These are my personal steps. This should not be construed as official guidance. Always refer to the official Microsoft documentation available at learn.microsoft.com</p>","tags":["M365"]},{"location":"M365/Fresh_Tenant_Setup/#entra","title":"Entra","text":"","tags":["M365"]},{"location":"M365/Fresh_Tenant_Setup/#entra-cloud-sync","title":"Entra Cloud Sync","text":"<p> Portal  Docs</p> <p>Cloud Sync is the lightweight replacement for AAD Connect. Follow the instructions in the Docs link for a step-by-step example for a single forest install.</p> <p>For conditional access, be sure to exclude the Directory Synchronization Accounts role from any MFA policies.</p>","tags":["M365"]},{"location":"M365/Fresh_Tenant_Setup/#hybrid-cloud-trust","title":"Hybrid Cloud Trust","text":"<p> Docs</p> <p>Create EntraID Kerberos Server</p> <pre><code># Install the AzureADHybridAuthenticationManagement module\nInstall-Module -Name AzureADHybridAuthenticationManagement -AllowClobber\n\n# Specify the on-premises Active Directory domain. A new Azure AD\n# Kerberos Server object will be created in this Active Directory domain.\n$domain = \"contoso.com\"\n\n# Enter a UPN of an Azure Active Directory global administrator\n$userPrincipalName = \"admin@contoso.com\"\n\n# Enter a domain administrator username and password.\n$domainCred = Get-Credential\n\n# Create the new Azure AD Kerberos Server object in Active Directory\n# and then publish it to Azure Active Directory.\n# Open an interactive sign-in prompt with given username to access the Azure AD.\nSet-AzureADKerberosServer -Domain $domain -UserPrincipalName $userPrincipalName -DomainCredential $domainCred\n\n# Verify server\nGet-AzureADKerberosServer -Domain $domain -DomainCredential $domainCred -UserPrincipalName $userPrincipalName\n\nId                 : 17530\nUserAccount        : CN=krbtgt_AzureAD,CN=Users,DC=contoso,DC=com\nComputerAccount    : CN=AzureADKerberos,OU=Domain Controllers,DC=contoso,DC=com\nDisplayName        : krbtgt_17530\nDomainDnsName      : contoso.com\nKeyVersion         : 27591\nKeyUpdatedOn       : 10/13/2022 9:23:43 PM\nKeyUpdatedFrom     : CONTOSO-DC-01.contoso.com\nCloudDisplayName   : krbtgt_17530\nCloudDomainDnsName : contoso.com\nCloudId            : 17530\nCloudKeyVersion    : 27591\nCloudKeyUpdatedOn  : 10/13/2022 9:23:43 PM\nCloudTrustDisplay  :\n</code></pre>","tags":["M365"]},{"location":"M365/Fresh_Tenant_Setup/#device-settings","title":"Device Settings","text":"<p> Portal</p> <ul> <li>Disable adding GA to local admin. </li> </ul>","tags":["M365"]},{"location":"M365/Fresh_Tenant_Setup/#app-registrations","title":"App Registrations","text":"","tags":["M365"]},{"location":"M365/Fresh_Tenant_Setup/#ms-graph-powershell-sdk","title":"MS Graph PowerShell SDK","text":"<p>To enable use of the MS Graph PowerShell SDK, create an app registration for app-only for use with the SDK.</p> <p> Portal</p> <ol> <li>Create the app registration. </li> <li>Grant application permissions for Microsoft Graph that are necessary for your use cases.</li> <li>I prefer to do app consent cert-based authentication. Here's a couple of links explaining the process:<ol> <li>How to use Connect-MgGraph - All Options \u2014 LazyAdmin</li> <li>Use app-only authentication with the Microsoft Graph PowerShell SDK | Microsoft Learn</li> </ol> </li> </ol>","tags":["M365"]},{"location":"M365/Fresh_Tenant_Setup/#identity-protection","title":"Identity Protection","text":"","tags":["M365"]},{"location":"M365/Fresh_Tenant_Setup/#self-service-password-reset","title":"Self Service Password Reset","text":"<p> Portal  Docs</p> <ul> <li>Enable Self service password reset</li> <li>Target a group that excludes service accounts. Easiest way to do this is with a dynamic group. Example rule: <code>(user.displayName -ne \"On-Premises Directory Synchronization Service Account\") and (user.userPrincipalName -notStartsWith \"svc\")</code></li> <li>Enable Password writeback in On-premises integration </li> </ul>","tags":["M365"]},{"location":"M365/Fresh_Tenant_Setup/#authentication-methods","title":"Authentication Methods","text":"<p> Portal  Docs</p>","tags":["M365"]},{"location":"M365/Fresh_Tenant_Setup/#policies","title":"Policies","text":"<p>For methods, enable</p> <ul> <li>Passkeys</li> <li>Authenticator </li> <li>Enable FIDO2, Authenticator, Temporary Access Pass in Authentication Methods</li> </ul>","tags":["M365"]},{"location":"M365/Fresh_Tenant_Setup/#authentication-methods-migration","title":"Authentication Methods Migration","text":"<ul> <li>Disable verification options in the legacy MFA settings portal </li> <li>Disable Authentication methods in SSPR Authentication Methods </li> <li>Migrate to the Converged Authentication Methods Policy </li> </ul>","tags":["M365"]},{"location":"M365/Fresh_Tenant_Setup/#user-settings","title":"User Settings","text":"<p> Portal</p> <ul> <li>Toggle Off</li> <li>Users can register Applications</li> <li>Show keep user signed in</li> <li>Toggle On</li> <li>Restrict non-admin users from creating tenants</li> <li>Restrict access to Entra ID administration portal </li> </ul>","tags":["M365"]},{"location":"M365/Fresh_Tenant_Setup/#user-feature-settings","title":"User Feature Settings","text":"<p> Portal</p> <ul> <li>Select All for Users can use preview features for My Apps</li> </ul>","tags":["M365"]},{"location":"M365/Fresh_Tenant_Setup/#device-settings_1","title":"Device Settings","text":"","tags":["M365"]},{"location":"M365/Fresh_Tenant_Setup/#cloud-laps","title":"Cloud LAPS","text":"<p> Portal  Docs</p> <ul> <li>Enable LAPS </li> </ul>","tags":["M365"]},{"location":"M365/Fresh_Tenant_Setup/#enterprise-state-roaming","title":"Enterprise State Roaming","text":"<p> Portal</p> <ul> <li>Enable Enterprise State Roaming </li> </ul>","tags":["M365"]},{"location":"M365/Fresh_Tenant_Setup/#identity-protection_1","title":"Identity Protection","text":"","tags":["M365"]},{"location":"M365/Fresh_Tenant_Setup/#multifactor-authentication-registration-policy","title":"Multifactor authentication registration policy","text":"<ul> <li>Create a EntraID group called Service Accounts, add the Entra Cloud sync account</li> <li>Enable the policy, targeting all users and excluding the group you just created. </li> </ul>","tags":["M365"]},{"location":"M365/Fresh_Tenant_Setup/#diagnostic-settings","title":"Diagnostic Settings","text":"<p> Portal  Docs</p> <p>Prior to doing so, create a Log Analytics workspace and add Sentinel to it.</p> <ul> <li>Enable all diagnostic settings to log to your Sentinel's log analytics workspace </li> </ul>","tags":["M365"]},{"location":"M365/Fresh_Tenant_Setup/#global-secure-access","title":"Global Secure Access","text":"<p> Portal  Docs</p>","tags":["M365"]},{"location":"M365/Fresh_Tenant_Setup/#enable-gsa","title":"Enable GSA","text":"<p>Click Activate to enable GSA in your tenant </p>","tags":["M365"]},{"location":"M365/Fresh_Tenant_Setup/#internet-access","title":"Internet Access","text":"<ol> <li>Enable the Microsoft Profile </li> <li>Download the GSA Client and deploy to Windows devices.</li> </ol>","tags":["M365"]},{"location":"M365/Fresh_Tenant_Setup/#active-directory","title":"Active Directory","text":"<p>Deploy 3 VMs - 2 Domain Controllers running 2022 - 1 2022 Server for Entra Cloud Sync</p>","tags":["M365"]},{"location":"M365/Fresh_Tenant_Setup/#intune","title":"Intune","text":"","tags":["M365"]},{"location":"M365/Fresh_Tenant_Setup/#tenant-administration-settings","title":"Tenant Administration Settings","text":"","tags":["M365"]},{"location":"M365/Fresh_Tenant_Setup/#windows-data-connector","title":"Windows Data Connector","text":"<p>Portal</p> <p></p>","tags":["M365"]},{"location":"M365/Fresh_Tenant_Setup/#defender-for-endpoint-connector","title":"Defender for Endpoint Connector","text":"<p> Portal</p> <p>You need to enable the Defender side first.</p> <p></p>","tags":["M365"]},{"location":"M365/Fresh_Tenant_Setup/#windows-autopatch","title":"Windows Autopatch","text":"<p> Portal  Docs</p> <ul> <li>Run the prereq check. You'll see an advisory for co-management, this can be safely disregarded.</li> <li>Grant admin access for Microsoft</li> <li>Provide Admin contact info.</li> <li>Add devices to the the default autopatch group <code>Windows Autopatch Device Registration</code></li> <li>Wait a few minutes, then ensure the devices show in the Windows Autopatch devices here</li> <li>Put a couple of devices in the Test ring by clicking on the device name, then selecting Device Actions -&gt; Assign Ring. In the flyout, choose the Test ring</li> </ul>","tags":["M365"]},{"location":"M365/Fresh_Tenant_Setup/#applications","title":"Applications","text":"<p> Portal  Docs</p>","tags":["M365"]},{"location":"M365/Fresh_Tenant_Setup/#windows","title":"Windows","text":"<p>Add app -&gt; Microsoft 365 Apps for Windows 10 and Later. Assign to all devices.</p> <p> </p>","tags":["M365"]},{"location":"M365/Fresh_Tenant_Setup/#devices","title":"Devices","text":"","tags":["M365"]},{"location":"M365/Fresh_Tenant_Setup/#windows-automatic-enrollment","title":"Windows Automatic Enrollment","text":"<p> Portal</p> <ul> <li>Set MDM and MAM user scopes to all </li> </ul>","tags":["M365"]},{"location":"M365/Fresh_Tenant_Setup/#windows-autopilot","title":"Windows Autopilot","text":"<p> Portal</p> <p>Follow this guide: Overview for Windows Autopilot device preparation user-driven Microsoft Entra join in Intune | Microsoft Learn</p> <p>Prereqs:</p> <ul> <li>Create Entra Groups</li> <li>Automatic Enrolment Set</li> <li>Enrolled devices. Windows Autopilot device preparation devices<ul> <li>Set App ID f1346770-5b25-470b-88bd-d5744ab7952c as the owner.</li> <li>Targeted Users - Windows Autopilot device preparation users</li> </ul> </li> <li>Create/update an Office deployment, target the device group created above.</li> </ul> <p>Create a device prep policy </p>","tags":["M365"]},{"location":"M365/Fresh_Tenant_Setup/#ios-enrollment","title":"iOS Enrollment","text":"<p> Portal</p> <p>User-driven iOS enrollment is a two step process - the push certificate and the enrollment profile.</p>","tags":["M365"]},{"location":"M365/Fresh_Tenant_Setup/#configure-apple-mdm-push-certificate","title":"Configure Apple MDM Push Certificate","text":"<p> Docs</p> <p></p>","tags":["M365"]},{"location":"M365/Fresh_Tenant_Setup/#enrollment-profile","title":"Enrollment Profile","text":"<p> Portal</p> <p>Native iOS enrollment</p> <p>There's this nifty-keen account driven user enrollment available in iOS 15+, but you'll need a web server to serve up the json file Apple expects.</p> <ul> <li>Configure an enrollment profile</li> <li>Create a profile that allows user choice of type of device (corporate vs user), target all users. </li> </ul>","tags":["M365"]},{"location":"M365/Fresh_Tenant_Setup/#supervised-ios-enrollment-with-apple-configurator","title":"Supervised iOS Enrollment with Apple Configurator","text":"<p> Portal  Docs</p> <p>There are two options for Apple Config profile - with user affinity and without. For testing, enrollment with User Affinity with the Company Portal app mimics how devices might be distributed to end users.</p> <ol> <li>Create a new Enrollment Profile. On the settings step, select:    User affinity: <code>Enroll with User Affinity</code>    Select where users must authenticate: <code>Company Portal</code></li> <li>Export the profile you just created. Copy the URL. </li> <li>Create a csv file with the serial numbers of iPads you wish to enroll. <code>Serial number,device details</code></li> <li>Upload the csv file in the portal under Devices. Assign the profile you just created. </li> <li>In Apple Configurator, choose Settings -&gt; Servers. Click + to add a server. Add the URL you copied from step 2. </li> <li>Connect a device, and at the main screen, click Prepare. Leave the default options unchanged. </li> <li>Choose the Intune MDM server defined in Step 5. </li> <li>Skip Apple Business Manager sign-in if prompted. At the Organization screen select a previous org or create a new one. This is shown in the settings app in iOS.</li> <li>Choose to generate a new supervision Identity or reuse an existing one.</li> <li>Choose which steps to display in the Setup Assistant. Click Prepare to start the process.</li> </ol>","tags":["M365"]},{"location":"M365/Fresh_Tenant_Setup/#android-enrollment","title":"Android Enrollment","text":"<p> Portal  Docs</p> <p>User-driven Android enrollment is a two step process - the managed Google Play account linking  and the enrollment profile.</p>","tags":["M365"]},{"location":"M365/Fresh_Tenant_Setup/#managed-google-play-account-linking","title":"Managed Google Play Account Linking","text":"","tags":["M365"]},{"location":"M365/Fresh_Tenant_Setup/#macos-enrollment","title":"MacOS Enrollment","text":"<p> Portal  Docs</p> <p>As with MDE for MacOS, this tends to change, so be sure to check the docs for the most recent steps.</p> <p>:material-head-sync: tl;dr</p> <ul> <li>Create a MacOS enrollment profile here if you didn't for iOS yet - they're shared between iOS and MacOS. </li> <li>Download the Company Portal app for MacOS from here and deploy the company portal app as a MacOS LOB app </li> </ul>","tags":["M365"]},{"location":"M365/Fresh_Tenant_Setup/#macos-platform-sso","title":"MacOS Platform SSO","text":"<p>Use the instructions here as a guide.</p> <p>tl;dr Use the settings below in a config profile to deploy platform sso with the following options:</p> <ul> <li>Password authentication which syncs the Entra password with the local account password</li> <li>Create new users as admins</li> </ul> <p></p>","tags":["M365"]},{"location":"M365/Fresh_Tenant_Setup/#endpoint-security","title":"Endpoint security","text":"<p> Portal</p>","tags":["M365"]},{"location":"M365/Fresh_Tenant_Setup/#windows_1","title":"Windows","text":"<ul> <li>Endpoint Detection and Response</li> <li>Create a new EDR policy targeting Windows. Target all devices. </li> <li>Antivirus</li> <li>Create a new Microsoft Defender Antivirus profile </li> <li>Enable Network Protection in Block mode. Target all devices. </li> </ul>","tags":["M365"]},{"location":"M365/Fresh_Tenant_Setup/#macos","title":"MacOS","text":"<p>Deploying MDE on MacOS is a multi-step manual process, and changes occasionally. Refer to Intune-based deployment for Microsoft Defender for Endpoint on Mac - Microsoft Defender for Endpoint | Microsoft Learn for the most current steps.</p> <p> tl;dr If you want a sample combined deployment, I've combined mobileconfig files here to set the following settings</p> <ul> <li>AutoUpdate enabled, broad channel</li> <li>Network protection set to block</li> <li> <p>All other required mobileconfig settings, such as full disk access, etc.</p> </li> <li> <p>Deploy the combined profile</p> </li> <li>Create a device configuration profile for macOS devices using a custom template </li> <li>For configuration settings, upload the mobileconfig from above. Target device channel.</li> <li>Target all MacOS devices</li> <li>Deploy MDE</li> <li>Deploy the MDE packageMDE App in Intune</li> <li>Deploy the Onboarding Package</li> <li>Download the MDM/Intune onboarding package from Defender XDR </li> <li>Deploy via Intune as a Custom Config template </li> </ul>","tags":["M365"]},{"location":"M365/Fresh_Tenant_Setup/#security-baselines","title":"Security Baselines","text":"<ul> <li>Create a new Microsoft Defender for Endpoint Baseline policy and target all devices. </li> </ul>","tags":["M365"]},{"location":"M365/Fresh_Tenant_Setup/#account-protection-laps","title":"Account Protection (LAPS)","text":"<p> Portal</p> <ul> <li>Enable LAPS in the portal</li> <li>Create a Windows LAPS profile and apply to all devices. </li> </ul> <p></p>","tags":["M365"]},{"location":"M365/Fresh_Tenant_Setup/#m365-defender","title":"M365 Defender","text":"<p> Portal</p>","tags":["M365"]},{"location":"M365/Fresh_Tenant_Setup/#xdr","title":"XDR","text":"<ul> <li>Enable unified SIEM and XDR. </li> </ul>","tags":["M365"]},{"location":"M365/Fresh_Tenant_Setup/#email-collaboration","title":"Email &amp; collaboration","text":"<ul> <li>Peset Security Configuration Policies</li> <li> <p>Enable Standard Protection Preset Policies. </p> <p></p> <p></p> </li> </ul>","tags":["M365"]},{"location":"M365/Fresh_Tenant_Setup/#mdca","title":"MDCA","text":"<ul> <li>System</li> <li>IP Address Ranges<ul> <li>If you have IP Ranges as Trusted Named Locations in EID, add them as Custom IP Address Ranges in MDCA with the category of Corporate </li> </ul> </li> <li>Cloud Discovery</li> <li>Defender for Endpoint<ul> <li>Enforce App Access with Defender for Endpoint </li> </ul> </li> <li>User Enrichment<ul> <li>Enable User Enrichment </li> </ul> </li> <li>Information Protection</li> <li>Microsoft Information Protection<ul> <li>Enable automatically scan new files</li> <li>Enable scanning protected files. You'll need to go through the OAUTH grant process. </li> </ul> </li> <li>Files<ul> <li>Enable file monitoring </li> </ul> </li> <li>App governance</li> <li>Service Status<ul> <li>Turn on app governance </li> </ul> </li> <li>Connected Apps</li> <li>App Connectors<ul> <li>Click Connect an app, choose Microsoft 365 from the list. Select all options. </li> </ul> </li> <li>SIEM Agents</li> <li>Add the Azure Sentinel integration </li> </ul>","tags":["M365"]},{"location":"M365/Fresh_Tenant_Setup/#endpoints","title":"Endpoints","text":"<ul> <li>Advanced Features</li> <li>Ensure your settings match those below: </li> </ul>","tags":["M365"]},{"location":"M365/Fresh_Tenant_Setup/#identities","title":"Identities","text":"<ul> <li>Sensors</li> <li>Click +Add Sensor, and download the installer and copy the Access key </li> <li>Install the sensor on all DCs in AD. Use the access key when prompted by the installer. </li> <li>Active Directory</li> <li>Configure Event Collection via GPO</li> <li> <p>Configure Group Managed Service Account account</p> <ul> <li>On the first DC</li> <li> <p>Create root KDS key</p> <pre><code>Add-KdsRootKey -EffectiveTime ((get-date).addhours(-10))\n</code></pre> </li> <li> <p>Purge kerberos tickets</p> </li> </ul> <pre><code>klist purge -li 0x3e7\n</code></pre> <ul> <li>Create the gMSA</li> </ul> <pre><code>New-ADServiceAccount accountname -PrincipalsAllowedToRetrieveManagedPassword \"Domain Controllers\" -DNSHostName accountname.domain.contoso.com\n</code></pre> <ul> <li>Install the gMSA on the DC</li> </ul> <pre><code>Install-ADServiceAccount -Identity 'accountname'\n</code></pre> <ul> <li>On the other DCs, purge kerberos tickets and install the service account<ul> <li>Add the gMSA in the portal </li> </ul> </li> </ul> </li> </ul>","tags":["M365"]},{"location":"M365/Fresh_Tenant_Setup/#purview","title":"Purview","text":"","tags":["M365"]},{"location":"M365/Fresh_Tenant_Setup/#advanced-audit","title":"Advanced Audit","text":"<p> Portal</p> <ul> <li>Enable Auditing</li> <li> <p>With the ExchangeOnlineManagement module in PS5/PS7+</p> <pre><code>Enable-OrganizationCustomization\nSet-AdminAuditLogConfig -UnifiedAuditLogIngestionEnabled $true\n</code></pre> </li> </ul>","tags":["M365"]},{"location":"M365/Fresh_Tenant_Setup/#device-onboarding","title":"Device Onboarding","text":"<p> Portal  Windows  Mac</p> <ul> <li>Enable Windows and Mac device onboarding. This requires MDE.</li> </ul>","tags":["M365"]},{"location":"M365/Fresh_Tenant_Setup/#sensitivity-labels","title":"Sensitivity Labels","text":"","tags":["M365"]},{"location":"M365/Fresh_Tenant_Setup/#enable-labeling-for-protected-content-pdfs","title":"Enable labeling for Protected content &amp; PDFs","text":"<p> Enable Sensitivity Labels for Protected Content  Enable labeling support for PDFs</p> <ul> <li>Enable labeling for Protected content &amp; PDFs</li> <li> <p>Using the SharePoint Module in PowerShell 5</p> <pre><code>connect-sposervice -url 'https://&lt;tenant&gt;-admin.sharepoint.com/'\nSet-SPOTenant -EnableAIPIntegration $true\nSet-SPOTenant -EnableSensitivityLabelforPDF $true\n</code></pre> </li> </ul>","tags":["M365"]},{"location":"M365/Fresh_Tenant_Setup/#enable-labeling-for-containers","title":"Enable Labeling for Containers","text":"<p>In a fresh tenant, there will not be any EntraID group settings configured, so those need to be created. Then enable labeling for containers.  After that, you can enable the label sync.</p> <ul> <li> <p>With the Graph SDK in PS7+</p> <pre><code>Connect-MgGraph -Scopes \"Directory.ReadWrite.All\"\n$TemplateId = (Get-MgBetaDirectorySettingTemplate | where { $_.DisplayName -eq \"Group.Unified\" }).Id\n$params = @{\n   templateId = \"$TemplateId\"\n   values = @(\n      @{\n         name = \"EnableMIPLabels\"\n         value = \"True\"\n      }\n   )\n}\nNew-MgBetaDirectorySetting -BodyParameter $params\n</code></pre> </li> <li> <p>With the ExchangeOnlineManagement module in PS5/PS7+</p> <pre><code>Connect-IPPSSession\nExecute-AzureAdLabelSync\n</code></pre> </li> </ul>","tags":["M365"]},{"location":"M365/Fresh_Tenant_Setup/#enable-co-authoring-for-encrypted-files","title":"Enable co-authoring for Encrypted Files","text":"<p>This can be done in the portal, or via PowerShell.</p> <ul> <li> <p>With the ExchangeOnlineManagement module in PS5/PS7+</p> <pre><code>Connect-IPPSSession\nSet-PolicyConfig -EnableLabelCoauth:$true\n</code></pre> </li> </ul>","tags":["M365"]},{"location":"M365/Fresh_Tenant_Setup/#implement-secure-by-default-labeling","title":"Implement Secure by Default Labeling","text":"<p>Follow the guide here </p>","tags":["M365"]},{"location":"M365/Fresh_Tenant_Setup/#dlp","title":"DLP","text":"","tags":["M365"]},{"location":"M365/Fresh_Tenant_Setup/#endpoint-dlp","title":"Endpoint DLP","text":"","tags":["M365"]},{"location":"M365/Fresh_Tenant_Setup/#settings","title":"Settings","text":"<p> Portal  Docs</p> <p>In Settings, change the following:</p> <ul> <li>Advanced classification scanning and protection: <code>On</code></li> </ul>","tags":["M365"]},{"location":"M365/Fresh_Tenant_Setup/#mip-scanner","title":"MIP Scanner","text":"<p> Portal  Docs</p> <p>Prerequisite</p> <ul> <li>Service account in AD, exclude from MFA registration and CAs</li> <li>SQL server for the scanner, as well as a windows server.</li> </ul> <p>Deployment</p> <ul> <li>Create a Scanner Cluster </li> <li>Create a Content Scan Job. Be sure to disable any of the auto options - this will just be for scanning. </li> </ul>","tags":["M365"]},{"location":"M365/Fresh_Tenant_Setup/#exact-data-match","title":"Exact Data Match","text":"<p> Portal  Docs</p>","tags":["M365"]},{"location":"M365/Fresh_Tenant_Setup/#edm-sit","title":"EDM SIT","text":"<ul> <li>Create a new EDM SIT. Since I work in healthcare, I typically use Synthea to generate patient records. We do have sample industry files you can use. </li> <li>Make note of the datastore name when you finish the EDM wizard. You'll need it for the EDM uploader.</li> </ul>","tags":["M365"]},{"location":"M365/Fresh_Tenant_Setup/#edm-uploader-tool","title":"EDM Uploader Tool","text":"<ol> <li>Create a service account for the EDM upload agents to run as.</li> <li>Create a EntraID security group named <code>EDM_DataUploaders</code> and add the service account to it.</li> <li>Install the EDM upload tool to <code>c:\\EDM</code></li> <li>Place sample data in <code>c:\\EDM\\Data</code></li> <li>Save the schema <code>.\\EdmUploadAgent.exe /SaveSchema /DataStoreName your_data_store_name /OutputDir c:\\edm\\data</code></li> <li>Create <code>c:\\EDM\\hash</code></li> <li>Upload the data <code>.\\EdmUploadAgent.exe /uploaddata /datastorename your_data_store_name /datafile C:\\edm\\data\\your_data.csv /hashlocation c:\\edm\\hash /schema C:\\edm\\data\\your_data_store_name.xml /allowedbadlinespercentage 5</code></li> </ol>","tags":["M365"]},{"location":"M365/Fresh_Tenant_Setup/#insider-risk-management","title":"Insider Risk Management","text":"<p>Work in Progress</p> <p>This section is not complete.</p>","tags":["M365"]},{"location":"M365/Fresh_Tenant_Setup/#roles","title":"Roles","text":"<p> Portal  Docs </p> <ul> <li>Add your account to the <code>Insider Risk Management</code> role.</li> <li>Create a role group called <code>Data Connector Admins</code>, add the <code>Data Connector Admin</code> role to it and add your account to the role group.</li> </ul>","tags":["M365"]},{"location":"M365/Fresh_Tenant_Setup/#browser-activity-plugins","title":"Browser Activity Plugins","text":"<ul> <li>Deploy the Edge profile via Intune as described here</li> <li>Deploy the Chrome profile via Intune as described here</li> </ul>","tags":["M365"]},{"location":"M365/Fresh_Tenant_Setup/#hr-connector","title":"HR Connector","text":"<ol> <li>Create an Entra App Registration with Client Secret </li> </ol>","tags":["M365"]},{"location":"M365/Fresh_Tenant_Setup/#settings_1","title":"Settings","text":"<p> Portal  Docs</p> <ul> <li>Analytics</li> <li>Toggle analytics on</li> <li>Data sharing</li> <li>Enable share data with Defender XDR</li> <li>Policy indicators</li> <li>Select all indicators under the following categories<ul> <li>Office</li> <li>Microsoft Defender for Cloud Apps</li> <li>Cumulative exfiltration detection</li> <li>Risk score boosters</li> <li>Generative AI Apps</li> <li>Microsoft Copilot Experiences</li> <li>Microsoft Entra</li> <li>Risk Detection indicators</li> </ul> </li> </ul>","tags":["M365"]},{"location":"M365/Fresh_Tenant_Setup/#analytics","title":"Analytics","text":"<ul> <li>Toggle analytics on</li> </ul>","tags":["M365"]},{"location":"M365/Fresh_Tenant_Setup/#policy-indicators","title":"Policy Indicators","text":"<ul> <li>Select all indicators under the following categories</li> <li>Office</li> <li>Device</li> <li>Microsoft Defender for Endpoint</li> <li>Risky Browsing</li> <li>Microsoft Defender for Cloud Apps</li> </ul>","tags":["M365"]},{"location":"M365/Fresh_Tenant_Setup/#adaptive-protection","title":"Adaptive Protection","text":"<p>Portal</p> <ol> <li>Turn on adaptive protection with the quick setup option </li> <li>Wait for that to process. Once complete, go back and enable Adaptive Protection under Adaptive Protection settings </li> </ol>","tags":["M365"]},{"location":"M365/Fresh_Tenant_Setup/#polices","title":"Polices","text":"<p> Portal  Docs</p> <ol> <li>Create a Data Leaks policy from the template </li> <li>Target all users</li> <li>Choose not to prioritize content. </li> <li>For triggering events, choose <code>User performs an exfiltration activity</code></li> <li>For thresholds, choose <code>Apply built-in thresholds.</code></li> <li>For indicators, leave the default ones checked.</li> </ol>","tags":["M365"]},{"location":"M365/Fresh_Tenant_Setup/#communication-compliance","title":"Communication Compliance","text":"<p>Portal</p> <ul> <li>Grant Teams meeting recording access.</li> </ul>","tags":["M365"]},{"location":"Purview/SITs_for_Table-based_Data/","title":"SITs for Table-based Data","text":"","tags":["Purview"]},{"location":"Purview/SITs_for_Table-based_Data/#proximity","title":"Proximity","text":"<p>With Sensitive Information Types in Purview, the supporting elements typically are set to be within 300 characters of the match. This works well for text documents and emails, but is less effective for table-based data like spreadsheets or csv files.</p> <p>For example, let's take a fictitious Medical Record Number. This example is a variable length number with no other formatting, and no padding. This is fairly common, especially with mixed MRN systems.</p> <p>127528819: 6-9 digits</p> <p>The corresponding regex to find this MRN is this: <pre><code>\\b\\d{6,9}\\b\n</code></pre></p> <p>The custom SIT definition looks like this:</p> <p>Pattern #1</p> <ul> <li>Confidence: High</li> <li>Regular Expression: <code>\\b\\d{6,9}\\b</code></li> <li>Character proximity: 300 characters (default)</li> <li>Supporting elements: case insensitive keywords<ul> <li>MRN, Medical Record Number, Record Number</li> </ul> </li> </ul> <p>Pattern #2</p> <ul> <li>Confidence: Low</li> <li>Regular Expression: <code>\\b\\d{6,9}\\b</code></li> <li>Character proximity: 300 characters (default)</li> <li>Supporting elements: none</li> </ul> <p>Test Data Our test data is a simple, fake extract from a MRN system. Note that MRN is the first column, and the column name is one of our keywords (mrn).</p> <pre><code>\"mrn\",\"firstname\",\"lastname\",\"dob\",\"address\",\"city\",\"state\",\"zip\",\"phone\",\"email\"\n\"492338213\",\"Kelly\",\"Pratt\",\"2001-09-28\",\"80947 Nelson Estates Apt. 763\",\"Kathyfort\",\"HI\",\"66442\",\"+1-578-586-3745x48021\",\"wking@example.com\"\n\"789241276\",\"John\",\"Arnold\",\"1955-10-28\",\"03741 Sanchez Shore\",\"South Anthonyview\",\"MN\",\"56561\",\"+1-988-725-1788x1975\",\"michael33@example.org\"\n\"719643833\",\"Steven\",\"Wilson\",\"1948-06-19\",\"341 Brooks Courts\",\"Lake Candiceside\",\"ND\",\"92691\",\"001-933-368-7396x72128\",\"yclark@example.net\"\n\"913581370\",\"Laura\",\"Mitchell\",\"1951-11-25\",\"8421 Kelley Islands Suite 633\",\"Kramerfort\",\"NM\",\"30252\",\"760.462.3509x7056\",\"shawn66@example.org\"\n\"175729777\",\"Sean\",\"Lewis\",\"1943-11-17\",\"3140 Hunt Track Apt. 116\",\"Jamesview\",\"CO\",\"86702\",\"001-964-653-2716x1838\",\"aliciawilson@example.net\"\n\"76761344\",\"Paul\",\"Booth\",\"1936-09-17\",\"3297 Juan Field Apt. 857\",\"Tanyafurt\",\"MT\",\"80739\",\"358.612.7934x4561\",\"victoriawilson@example.com\"\n\"286086254\",\"Samantha\",\"Pham\",\"2018-08-23\",\"600 Kimberly Glen Suite 866\",\"Lake Alexanderville\",\"NE\",\"64307\",\"350-511-9743x968\",\"michael35@example.net\"\n\"949601932\",\"Ethan\",\"Berry\",\"1933-02-14\",\"2593 Sandoval Pine\",\"Traceyside\",\"IA\",\"79382\",\"+1-682-236-0383x226\",\"natasha45@example.org\"\n\"206072596\",\"Sharon\",\"Davis\",\"2004-12-03\",\"444 Mark Station Apt. 787\",\"Lake Matthewville\",\"GU\",\"87599\",\"482.353.2044x885\",\"christine42@example.com\"\n\"586966326\",\"Patricia\",\"Roberts\",\"1952-01-18\",\"9939 Jones Flats\",\"Sullivanbury\",\"MT\",\"41356\",\"969-900-3288x749\",\"silvaronald@example.com\"\n</code></pre> <p>Testing the SIT Running this test data though the tester on the SIT definition, and you'll get something along the lines of this:</p> <p>Low - 10 unique matches</p> Matches Supporting Elements 206072596 - 286086254 - 492338213 \"mrn\" 789241276 \"mrn\" 76761344 - 949601932 - 719643833 - 175729777 - 913581370 - 586966326 - <p>High - 2 unique matches</p> Matches Supporting Elements 492338213 \"mrn\" 789241276 \"mrn\" <p>So why did the high only match two? Proximity. Think of CSVs as long run-on sentences. In our test data data above, 300 characters from \"mrn\" in the first line is around the middle of the third line. In our test data, MRNs that would match are highlighted in green, and those that are 300+ characters away from <code>mrn</code> in the first row won't match because of the distance between the actual MRN and the keyword mrn.</p> <p></p>","tags":["Purview"]},{"location":"Purview/SITs_for_Table-based_Data/#techniques","title":"Techniques","text":"<p>There are multiple ways to deal with this issue.</p>","tags":["Purview"]},{"location":"Purview/SITs_for_Table-based_Data/#keyword-removal","title":"Keyword removal","text":"<p>Creating a custom SIT based on a existing SIT, then removing the keyword requirements is one way to address the proximity requirements. The downside to this is an increase in false positives, especially in something like our MRN, where it's just nine digit number.</p>","tags":["Purview"]},{"location":"Purview/SITs_for_Table-based_Data/#increasing-proximity","title":"Increasing proximity","text":"<p>You can increase the proximity value, or select anywhere in the document. This can work, however, this does increase the false positive rate, and also increases the chance of the DCS scan timing out in larger documents.</p> <p></p>","tags":["Purview"]},{"location":"Purview/SITs_for_Table-based_Data/#adding-a-lookahead","title":"Adding a lookahead","text":"<p>Instead of the regex matching just one instance, incorporate positive lookahead into the MRN regex that looks for another instance of a MRN on the next line.</p> <pre><code>\"\\d{6,9}\"(?=.*\\n.*\"\\d{6,9}\")\n</code></pre> <p>This will, however, miss the last MRN, as it doesn't have a MRN following it on the next line. </p>","tags":["Purview"]},{"location":"Purview/SITs_for_Table-based_Data/#relaxing-proximity","title":"Relaxing proximity","text":"<p>This technique, featured on the Compliance CxE site, creates an custom SIT with settings that will increase matches by assuming that if there are 9 or more low confidence matches without keywords then those will be counted as high confidence as long as there are high confidence matches as well of the same type. This works well for table based data, where it's generally safe to assume that the column contains data that matches.</p> <p>In our example from above, our green MRNs are high, and the red MRNs will also be assumed to be high.</p> <p></p>","tags":["Purview"]},{"location":"Purview/SITs_for_Table-based_Data/#creating-a-relaxed-proximity-sit","title":"Creating a Relaxed Proximity SIT","text":"<ol> <li>We'll make a copy of our MRN sit in the UI. </li> <li> <p>Edit the copied sit. Duplicate the high confidence pattern (with keywords), remove the keywords and lower the confidence. </p> </li> <li> <p>Connect to the Compliance PowerShell. <pre><code>Connect-IPPSession\n</code></pre></p> </li> <li>Export the Custom Rule Pack to xml. The rule pack containing any duplicated base SITs is always called Microsoft.SCCManaged.CustomRulePack, so the export command would be this: <pre><code>$rulepack = Get-DlpSensitiveInformationTypeRulePackage -Identity \"Microsoft.SCCManaged.CustomRulePack\"\n[System.IO.File]::WriteAllBytes('purview_custom_rulepack.xml', $rulepack.SerializedClassificationRuleCollection)\n</code></pre></li> <li>Edit the XML in an editor such as VS Code</li> <li>Locate the rules element for the SIT you created earlier. Actual definitions are abstracted from the local-specific descriptions, so look in the <code>&lt;LocalizedStrings&gt;</code> find the names for the SITs and their matching guid.  </li> <li>Change relaxProximity from false to true and save. <pre><code>&lt;Entity id=\"f15a78fd-0cfe-4d19-a227-77eb3aa14ae6\" patternsProximity=\"300\" recommendedConfidence=\"75\" relaxProximity=\"true\"&gt;\n</code></pre></li> <li>Upload the rulepack: <pre><code>Set-DlpSensitiveInformationTypeRulePackage -FileData ([System.IO.File]::ReadAllBytes(\".\\purview_custom_rulepack.xml\"))\n</code></pre>     Answer Yes when prompted.</li> </ol> <p>After uploading, go back to the portal and test the SIT again with the same data as before. You'll notice that the matches that previously were lower confidence are included in the high, even though they do not have the <code>mrn</code> keyword within 300 characters.</p>","tags":["Purview"]}]}